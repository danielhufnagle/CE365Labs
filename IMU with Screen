#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <MPU9250_WE.h> // Works fine for MPU-6500 too

// ======================
//  Hardware definitions
// ======================
#define MPU_ADDR 0x68
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);
MPU9250_WE mpu = MPU9250_WE(MPU_ADDR);

// ======================
//  Scroll state
// ======================
int scrollX = 0;
int scrollY = 0;
const int scrollSpeed = 3; // pixels per frame

void setup() {
  Serial.begin(115200);
  Wire.begin(); // SDA/SCL shared by OLED + MPU6500

  // ---- Initialize OLED ----
  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println("OLED not found!");
    while (1);
  }
  display.clearDisplay();
  display.setTextColor(SSD1306_WHITE);

  // ---- Initialize MPU ----
  if (!mpu.init()) {
    Serial.println("MPU not detected!");
    while (1);
  }
  Serial.println("MPU connected.");
  delay(500);
  mpu.autoOffsets();
  mpu.setAccRange(MPU9250_ACC_RANGE_2G);
  mpu.setGyrRange(MPU9250_GYRO_RANGE_250);
  mpu.enableAccDLPF(true);
  mpu.setAccDLPF(MPU9250_DLPF_4);
  mpu.enableGyrDLPF();
  mpu.setGyrDLPF(MPU9250_DLPF_4);
}

void loop() {
  // ---- Read sensor values ----
  xyzFloat acc = mpu.getGValues();
  xyzFloat gyr = mpu.getGyrValues();

  // ---- Determine scroll direction from tilt ----
  // Tilt thresholds: adjust as needed for your sensitivity
  if (acc.x > 0.4)      scrollY -= scrollSpeed; // Tilt forward → scroll up
  else if (acc.x < -0.4) scrollY += scrollSpeed; // Tilt back → scroll down

  if (acc.y > 0.4)      scrollX += scrollSpeed; // Tilt right → scroll right
  else if (acc.y < -0.4) scrollX -= scrollSpeed; // Tilt left → scroll left

  // ---- Keep scrolling bounds sane ----
  if (scrollX > SCREEN_WIDTH) scrollX = -SCREEN_WIDTH;
  if (scrollX < -SCREEN_WIDTH) scrollX = SCREEN_WIDTH;
  if (scrollY > SCREEN_HEIGHT) scrollY = -SCREEN_HEIGHT / 2;
  if (scrollY < -SCREEN_HEIGHT / 2) scrollY = SCREEN_HEIGHT / 2;

  // ---- Prepare display text ----
  char accelText[40];
  char gyroText[40];
  snprintf(accelText, sizeof(accelText), "ACC X:%+.2f Y:%+.2f Z:%+.2f", acc.x, acc.y, acc.z);
  snprintf(gyroText, sizeof(gyroText), "GYR X:%+.1f Y:%+.1f Z:%+.1f", gyr.x, gyr.y, gyr.z);

  // ---- Draw everything ----
  display.clearDisplay();
  display.setTextSize(1);

  display.setCursor(4 + scrollX / 4, 10 + scrollY / 4); // small parallax movement
  display.println("MPU-6500 Live Data");

  display.setTextSize(1);
  display.setCursor(scrollX, 30 + scrollY);
  display.println(accelText);

  display.setCursor(scrollX, 45 + scrollY);
  display.println(gyroText);

  display.display();
  delay(50);
}
